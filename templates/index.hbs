<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8"/>

<!-- TODO: Use .htaccess or some other way of sending this header -->
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<title>Office Hours Queue</title>
<meta name="description" content=""/> <!-- TODO: Description -->
<meta name="viewport" content="width=device-width"/>

<!-- <link rel="stylesheet" type="text/css" href="{{staticDir}}/css/main.css"/> -->

</head>
<body>
<!--[if lt IE 7]><p class="chromeframe">Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->



<div id="content" role="main">
  <p class="empty-queue">Queue&rsquo;s empty!</p>
  <form method="POST" action="/enqueue" id="enqueue-form">
    <input type="text" id="name" name="name" placeholder="Enter your name..."/>
    <input type="submit" id="submit-btn" class="btn" value="Enqueue"/>
  </form>
</div><!--/#all-->



<!-- Scripts -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="{{staticDir}}/js/vendor/jquery-1.7.2.min.js"><\/script>')</script>

<script src="{{staticDir}}/js/vendor/underscore-1.3.3.js"></script>
<script src="{{staticDir}}/js/vendor/backbone-0.9.2.js"></script>

<script src="{{staticDir}}/js/vendor/handlebars-1.0.0.beta.6.js"></script>

<script src="/socket.io/socket.io.js"></script>


<!-- Handlebars & Templates -->
{{#templates}}
<script id="{{template_name}}-tpl" type="text/x-handlebars-template">
{{{template}}}
</script>
{{/templates}}


<!-- My App -->
<script>
// var socket = io.connect('http://localhost:8080/');

// socket.on('enqueue', function(nameObj) {
//   console.log('Enqueue ' + nameObj.name);
// });

// socket.on('message', function(data) {
//   console.log('New message: ' + data.body);
// });
'use strict';
// On page ready
$(function() {

  window.log = console.log;

  var ohq = window.ohq = window.ohq || {
    SOCKET_SERVER: 'http://localhost:8080/',
    templates: {},
    socket: null
  };


  // Queue Item Model
  // ----------------
  ohq.QueueItem = Backbone.Model.extend({

    defaults: function() {
      log('Call defaults');
      // Wrap in a function so as not to share default object
      return { canEdit: false };
    },

    initialize: function() {
      log('Call initialize');
      this.set({
        enqueueTime: (new Date()).getTime()
      });
    },

    validate: function(attrs) {
      if (!$.trim(attrs.name))
        return "A QueueItem must have a name.";
      if (!attrs.enqueueTime || 
          typeof attrs.enqueueTime != 'number')
        return "A QueueItem must have an integer timestamp.";
      if (attrs.enqueueTime > (new Date()).getTime())
        return "A QueueItem must have a timestamp in the past.";
    }

  });


  // Queue Collection
  // ----------------
  ohq.Queue = Backbone.Collection.extend({

    model: QueueItem,

    comparator: function(queueItem) {
      return queueItem.get('enqueueTime');
    }

  });


  // Queue Item View
  // ---------------
  ohq.QueueItemView = Backbone.View.extend({

    model: QueueItem,

    template: ohq.templates.queue_item,

    toTemplateMap: function() {
      var map = ohq.jsonToTemplateMap(this.model.toJSON());
      map['human_enqueue_time'] = 
          ohq.humanizeTime(this.model.get('enqueueTime'));
    }

  });


  // App Functions
  // -------------
  ohq.jsonToTemplateMap = function(json) {
    var map = {};
    for (var key in json)
      map[ohq.toUnderscore(key)] = json[key];
    return map;
  };

  ohq.toUnderscore = function(str) {
    return str.replace(/[A-Z]/g, '_$&').toLowerCase();
  };

  ohq.humanizeTime = function(unixTime) {
    var diff = ((new Date()).getTime() - unixTime) / (1000 * 60);
    return (diff < 1 ? '&lt;1' : Math.floor(diff)) + 
        ' <abbr title="minute">min.</abbr>';
  }

  /**
   * Kick off
   * @param {Object} [qData] Some data to get started on.
   */
  ohq.init = function(qData) {

    // Initiate socket connection
    ohq.socket = io.connect(ohq.SOCKET_SERVER);
    ohq.templates = {
      queue: ohq.getTpl('queue'),
      queue_item: ohq.getTpl('queue_item')
    };
  };

  ohq.handleFormSubmit = function() {
    var name = $.trim($('#name').val());
    if (name) {
      console.log('Submit');
      ohq.socket.emit('submit', { name: name });
    }
    return false;
  };

  ohq.attachHandlers = function() {
    $('#enqueue-form').on('submit', ohq.handleFormSubmit);
  };

  var testData = {
    queue: [
      newQItem('Foo', 1341986277070, true),
      newQItem('Bar', 1341986639643, false),
      newQItem('Baz', 1341986652980, false),
      newQItem('Bux', 1341986279661, true),
    ],
    ta_present: true
  };

  ohq.newQItem = function(name, time, canEdit) {
    return {
      name: name,
      enqueue_time: time,
      human_enqueue_time: (new Date(time)).toString(),
      can_edit: canEdit
    };
  };

  ohq.getTpl = function(tplName) {
    var source = $('#' + tplName + '-tpl').html()
  };

  ohq.init(testData);

});
</script>

<!-- Google Analytics -->
<script>
// TODO: Set up analytics
var _gaq = [['_setAccount', 'UA-XXXXX-X'], ['_trackPageview']];
(function(d, t) {
  var g = d.createElement(t),
    s = d.getElementsByTagName(t)[0];
  g.src = ('https:' == location.protocol ? '//ssl' : '//www') + 
      '.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g, s)
}(document, 'script'));
</script>
</body>
</html>
